---
layout: default
title: Версионирование данных
nav_order: 1
parent: Загрузка данных
grand_parent: Работа с системой
has_children: false
has_toc: false
---

# Версионирование данных {#data_versioning}

Все записи [логической таблицы](../../../overview/main_concepts/logical_table/logical_table.md)
с одинаковым первичным ключом рассматриваются системой как исторические состояния одного объекта.
Объект может одновременно иметь множество архивных состояний, а также не более одного актуального
и не более одного нового («горячего») состояния.

Раздел описывает версионирование данных логических таблиц. Данные standalone-таблиц существуют вне механизмов 
[дельт](../../../overview/main_concepts/delta/delta.md) и версионирования.
{: .note-wrapper}

Данные, добавленные в логическую таблицу с помощью функций [загрузки](../data_upload.md) и 
[обновления](../../data_update/data_update.md) данных, считаются новым состоянием объектов и 
сохраняются в виде горячих записей. При [закрытии дельты и фиксации изменений](../../../reference/sql_plus_requests/COMMIT_DELTA/COMMIT_DELTA.md) 
система одномоментно обновляет состояние объектов, исключая чтение горячих данных.

Состояние данных обновляется в следующем порядке:

1. По каждой горячей записи:
   1. Выполняется поиск соответствующей актуальной записи. Записи сопоставляются по значению первичного ключа.
   2. Если актуальная запись найдена, она становится архивной. 
   3. Горячая запись становится актуальной, если содержит признак добавления, или удаляется, если содержит признак удаления.
2. В историю изменений данных добавляется новая [дельта](../../../overview/main_concepts/delta/delta.md) 
   с номером, равным номеру предыдущей дельты + 1.

Под признаком добавления или удаления записи понимается значение `sys_op`
(0 — добавление, 1 — удаление), если запись была [загружена](../data_upload.md), и тип запроса
([INSERT VALUES](../../../reference/sql_plus_requests/INSERT_VALUES/INSERT_VALUES.md), 
[INSERT SELECT](../../../reference/sql_plus_requests/INSERT_SELECT/INSERT_SELECT.md) и 
[UPSERT VALUES](../../../reference/sql_plus_requests/UPSERT_VALUES/UPSERT_VALUES.md) — добавление,
[DELETE](../../../reference/sql_plus_requests/DELETE/DELETE.md) — удаление), если запись была 
[обновлена](../../data_update/data_update.md).
{: .note-wrapper}

## Пример версионирования данных {#versioning_example}

Рассмотрим пример версионирования данных одного магазина. Представим, что какое-то время назад 
магазин переехал с адреса `ул. Старая, 9` на `ул. Новая, 11`, и это изменение было зафиксировано в логической таблице 
`stores`. А теперь категория магазина поменялась с `basic` на `vip`, и эта информация загружена в горячей дельте.

Данные магазина обновляются в следующем порядке (см. рисунок ниже):
1.  При загрузке запись с новой категорией сохраняется как горячая запись.
2.  При закрытии дельты запись с предыдущей категорией становится архивной, а 
    запись с новой категорией — актуальной. Обновление записей происходит одномоментно.

На рисунке ниже показаны версии записей до и после закрытия одной дельты. Актуальные версии записей помечены 
значком пользователя: именно их система по умолчанию возвращает на запрос внешней системы, если в запросе 
не указан момент времени, на который запрашиваются данные.

![](data_versioning.svg){:height="70%" width="70%"}
{: .figure-center}
*Обновление данных магазина*
{: .figure-caption-center}