---
layout: default
title: UPSERT VALUES
nav_order: 45
parent: Запросы SQL+
grand_parent: Справочная информация
has_children: false
has_toc: false
---

# UPSERT VALUES
{: .no_toc }

<details markdown="block">
  <summary>
    Содержание раздела
  </summary>
  {: .text-delta }
1. TOC
{:toc}
</details>

Запрос позволяет вставить записи в [логическую таблицу](../../../overview/main_concepts/logical_table/logical_table.md): 
добавить новые записи и (или) обновить существующие записи. Существование записи в таблице система определяет по значению 
первичного ключа.
Для новой записи должны быть указаны значения всех обязательных столбцов.

И новые, и существующие записи заполняются значениями из запроса. 
Различается только обработка опциональных столбцов, для которых нет значений в запросе:
* в новой записи такие столбцы заполняются значениями,
  используемыми по умолчанию в [СУБД](../../../introduction/supported_DBMS/supported_DBMS.md)
  [хранилища](../../../overview/main_concepts/data_storage/data_storage.md).
* в существующей записи такие столбцы остаются без изменений.

Запрос поддерживается для ADB и ADP.
{: .note-wrapper}

В отличие от [INSERT VALUES](../INSERT_VALUES/INSERT_VALUES.md), запрос `UPSERT VALUES` обновляет существующую запись 
только теми значениями, которые указаны в запросе. 
Для полного обновления существующих записей следует использовать запрос [INSERT VALUES](../INSERT_VALUES/INSERT_VALUES.md).
<br>Для обновления большого объема данных следует использовать
[загрузку данных](../../../working_with_system/data_upload/data_upload.md).
{: .note-wrapper}

Запрос обрабатывается в порядке, описанном в разделе 
[Порядок обработки запросов на обновление данных](../../../overview/interactions/llw_processing/llw_processing.md).
Вставка данных в [логические](../../../overview/main_concepts/logical_view/logical_view.md)
и [материализованные представления](../../../overview/main_concepts/materialized_view/materialized_view.md)
недоступна.

В ответе возвращается:
*   пустой объект ResultSet при успешном выполнении запроса;
*   исключение при неуспешном выполнении запроса.

При успешном выполнении запроса записи вставляются в [СУБД](../../../introduction/supported_DBMS/supported_DBMS.md) 
[хранилища](../../../overview/main_concepts/data_storage/data_storage.md), 
в которых размещены данные логической таблицы. При фиксации изменений каждая вставленная запись становится актуальной 
записью таблицы, а предыдущая актуальная запись, если такая есть, становится архивной.

Месторасположение данных таблицы можно задавать запросами 
[CREATE TABLE](../CREATE_TABLE/CREATE_TABLE.md) и [DROP TABLE](../DROP_TABLE/DROP_TABLE.md) с ключевым словом 
`DATASOURCE_TYPE`.
{: .note-wrapper}

Все записи таблицы с одинаковым первичным ключом рассматриваются системой как
различные исторические состояния одного объекта. Подробнее о версионировании
см. в разделе [Версионирование данных](../../../working_with_system/data_upload/data_versioning/data_versioning.md).
{: .note-wrapper}

Если [операция записи](../../../overview/main_concepts/write_operation/write_operation.md), запущенная запросом 
`UPSERT VALUES`, зависла, горячую [дельту](../../../overview/main_concepts/delta/delta.md) невозможно 
[закрыть](../COMMIT_DELTA/COMMIT_DELTA.md) или [откатить](../ROLLBACK_DELTA/ROLLBACK_DELTA.md). В этом случае нужно 
повторить запрос. Действие перезапустит обработку операции, и после ее завершения можно будет закрыть или откатить дельту.
Список незавершенных (в том числе — зависших) операций можно посмотреть с помощью запроса 
[GET_WRITE_OPERATIONS](../GET_WRITE_OPERATIONS/GET_WRITE_OPERATIONS.md).

## Синтаксис {#syntax}

Вставка данных во все столбцы логической таблицы:
```sql
UPSERT INTO [db_name.]table_name VALUES (value_list_1), (value_list_2), ...
```

Вставка данных только в некоторые столбцы логической таблицы
(с сохранением значений остальных столбцов без изменений):
```sql
UPSERT INTO [db_name.]table_name (column_list) VALUES (value_list_1), (value_list_2), ...
```

Параметры:
*   `db_name` — имя логической базы данных. Опционально, если выбрана логическая БД, 
    [используемая по умолчанию](../../../working_with_system/other_features/default_db_set-up/default_db_set-up.md);
*   `table_name` — имя логической таблицы, в которую вставляются данные;
*   `column_list` — список имен столбцов логической таблицы. Имена указываются в круглых скобках через запятую. 
    Список опционален, если количество и порядок вставляемых значений (в списке `value_list_N`) соответствуют количеству и 
    порядку столбцов в логической таблице;
*   `value_list_N` — список значений, вставляемых в столбцы логической таблицы. Значения указываются в круглых скобках 
    через запятую. Каждый такой список — это строка, вставляемая в таблицу. 

## Ограничения {#restrictions}

* Выполнение запроса возможно только при наличии открытой дельты (см. [BEGIN DELTA](../BEGIN_DELTA/BEGIN_DELTA.md)).
* Столбцы в запросе не могут иметь имена, зарезервированные для служебного использования: `sys_op`, `sys_from`,
  `sys_to`, `sys_close_date`, `bucket_id`, `sign`.
* Не допускается выполнение идентичных параллельных запросов.

## Пример {#examples}

### Вставка данных во все столбцы таблицы {#all_columns_example}

```sql
-- выбор логической базы данных sales в качестве базы данных по умолчанию
USE sales;

-- открытие новой (горячей) дельты
BEGIN DELTA;

-- вставка трех записей в логическую таблицу sales
UPSERT INTO sales 
VALUES (200011, '2021-08-21 23:34:10', 'ABC0001', 2, 123, 'Покупка по акции "1+1"'), 
       (200012, '2021-08-22 10:05:56', 'ABC0001', 1, 234, 'Покупка без акций'), 
       (200013, '2021-08-22 13:17:47', 'ABC0002', 4, 123, 'Покупка по акции "Лето"');

-- закрытие дельты (фиксация изменений)
COMMIT DELTA;
```

### Вставка данных в указанные столбцы таблицы {#some_columns_example}

```sql
-- открытие новой (горячей) дельты
BEGIN DELTA;

-- вставка двух записей в логическую таблицу sales (без опционального значения description)
UPSERT INTO sales.sales 
       (id, transaction_date, product_code, product_units, store_id)
VALUES (200014, '2021-08-23 09:34:10', 'ABC0003', 3, 123), 
       (200012, '2021-08-23 20:05:56', 'ABC0001', 6, 234);

-- закрытие дельты (фиксация изменений)
COMMIT DELTA;
```
