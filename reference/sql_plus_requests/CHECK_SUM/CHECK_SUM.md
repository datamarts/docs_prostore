---
layout: default
title: CHECK_SUM
nav_order: 7
parent: Запросы SQL+
grand_parent: Справочная информация
has_children: false
has_toc: false
---

# CHECK_SUM
{: .no_toc }

<details markdown="block">
  <summary>
    Содержание раздела
  </summary>
  {: .text-delta }
1. TOC
{:toc}
</details>

Запрос позволяет рассчитать контрольную сумму изменений в указанной [дельте](../../../overview/main_concepts/delta/delta.md).
Под изменениями понимаются записи, [загруженные](../../../working_with_system/data_upload/data_upload.md) и 
[обновленные](../../../working_with_system/data_update/data_update.md) в дельте. Дельта может быть закрытой или открытой 
(горячей).

Контрольную сумму можно рассчитать по следующим данным:
*   отдельным столбцам [логической таблицы](../../../overview/main_concepts/logical_table/logical_table.md) или 
    [материализованного представления](../../../overview/main_concepts/materialized_view/materialized_view.md),
*   всем столбцам логической таблицы или материализованного представления,
*   всем логическим таблицам [логической базы данных](../../../overview/main_concepts/logical_db/logical_db.md).

Контрольная сумма рассчитывается по каждой [СУБД](../../../introduction/supported_DBMS/supported_DBMS.md)
[хранилища](../../../overview/main_concepts/data_storage/data_storage.md),
которая хранит данные проверяемой логической сущности. Порядок расчета описан
[ниже](#checksum_algorithms).

При расчете контрольной суммы по отдельным столбцам рекомендуется добавлять первичный ключ в список столбцов. Это повысит
уникальность контрольных сумм, рассчитываемых по разным данных.
{: .tip-wrapper}

Чтобы рассчитать контрольную сумму по актуальным данным, а не изменениям данных, используйте запрос
[CHECK_SUM_SNAPSHOT](../CHECK_SUM_SNAPSHOT/CHECK_SUM_SNAPSHOT.md).
{: .tip-wrapper}

В ответе возвращается:
* объект ResultSet с контрольной суммой при успешном выполнении запроса и отсутствии расхождений между СУБД хранилища;
* исключение при наличии расхождений или неуспешном выполнении запроса.

Если контрольные суммы различаются между СУБД хранилища, система возвращает исключение
`Consistency breach detected for <entity_name>`. Исключение содержит список контрольных сумм по всем проверенным СУБД. 
При расчете контрольной суммы по логической базе данных система возвращает исключение по первому найденному расхождению и
не проверяет следующие сущности.

Значения типа FLOAT и DOUBLE могут иметь разные контрольные суммы из-за разницы в точности типов. Чтобы избежать
расхождения в контрольных суммах, используйте для всех значений с плавающей точкой тип
DOUBLE (как более распространенный среди СУБД) или исключайте столбцы типа FLOAT и DOUBLE из запросов `CHECK_SUM_SNAPSHOT`.
{: .note-wrapper}

## Синтаксис {#syntax}

```sql
CHECK_SUM(delta_num[, normalization][, [db_name.]entity_name[, square-bracketed_column_list]])
```

Параметры:
* `delta_num` — номер дельты, по которой рассчитывается контрольная сумма изменений;
* `normalization` (опциональный) — коэффициент, который повышает лимит на количество проверяемых записей в одной сущности,
   но снижает уникальность контрольных сумм. Может принимать любое целое значение, начиная с 1. Значение по умолчанию — 1. 
   Если коэффициент не указан или равен 1, проверяемая сущность может содержать до `4'294'967'298` загруженных записей 
   в дельте; при увеличении коэффициента лимит увеличивается пропорционально;
* `db_name` (опциональный) — имя логической базы данных, которой принадлежит проверяемая сущность. Опционально, если 
   выбрана логическая БД, [используемая по умолчанию](../../../working_with_system/other_features/default_db_set-up/default_db_set-up.md);
* `entity_name` (опциональный) — имя логической таблицы или материализованного представления, по которому 
   рассчитывается контрольная сумма;
* `square-bracketed_column_list` (опциональный) — список имен столбцов, по которым рассчитывается контрольная сумма. 
   Элементы списка перечисляются в квадратных скобках через запятую. Если столбцы не указаны, система рассчитывает 
   контрольную сумму по всем столбцам таблицы или представления.

## Ограничения {#restrictions}

* Контрольная сумма логической базы данных рассчитывается только по данным логических таблиц и не учитывает данные 
  материализованных представлений.
* Существует вероятность совпадения контрольных сумм для разных наборов данных.
* Количество проверяемых записей в одной сущности ограничено и регулируется коэффициентом нормализации. Если количество
  загруженных записей какой-либо сущности в указанной дельте больше `4'294'967'298`, нужно подобрать подходящее значение
  коэффициента нормализации.

## Примеры {#examples}

### Запрос по отдельным столбцам логической таблицы {#columns_example}

Расчет контрольной суммы по трем столбцам таблицы `sales` в десятой дельте:
```sql
CHECK_SUM(10,sales.sales,[id, transaction_date, product_code])
```

На рисунках ниже показаны примеры ответов на запрос `CHECK_SUM` с перечислением столбцов: 
на первом — ответ при отсутствии расхождений в данных между СУБД хранилища, на втором — ответ при 
наличии расхождений.

![](check_sum_for_table_columns.png){:height="70%" width="70%"}
{: .figure-center}
*Ответ CHECK_SUM по отдельным столбцам таблицы при отсутствии расхождений*
{: .figure-caption-center}

![](check_sum_with_inconsistency.png){:height="80%" width="80%"}
{: .figure-center}
*Ответ CHECK_SUM при наличии расхождений*
{: .figure-caption-center}

### Запрос по всем столбцам логической таблицы {#table_example}

Расчет контрольной суммы по всей таблице `sales` в десятой дельте:
```sql
CHECK_SUM(10,sales.sales)
```

На рисунке ниже показан пример ответа на запрос `CHECK_SUM` по логической таблице.

![](check_sum_for_table.png){:height="26%" width="26%"}
{: .figure-center}
*Ответ CHECK_SUM по логической таблице*
{: .figure-caption-center}

### Запрос по всем столбцам материализованного представления {#matview_example}

Расчет контрольной суммы по всему материализованному представлению `sales_by_stores` в десятой дельте:
```sql
CHECK_SUM(10,sales.sales_by_stores)
```

### Запрос по логической базе данных {#db_example}

Расчет контрольной суммы по всем таблицам логической базы данных `sales` в десятой дельте:
```sql
-- выбор логической базы данных sales в качестве базы данных по умолчанию
USE sales;

-- расчет контрольной суммы логической БД
CHECK_SUM(10);
```

На рисунке ниже показан пример ответа на запрос `CHECK_SUM` по логической базе данных.

![](check_sum_for_db.png){:height="20%" width="20%"}
{: .figure-center}
*Ответ CHECK_SUM по логической базе данных*
{: .figure-caption-center}

### Запрос по логической базе данных с коэффициентом нормализации {#example_with_normalization}

Расчет контрольной суммы по всем таблицам логической базы данных `sales` с коэффициентом нормализации, равным 100:
```sql
-- выбор логической базы данных sales в качестве базы данных по умолчанию
USE sales;

-- расчет контрольной суммы логической БД с указанным коэффициентом нормализации
CHECK_SUM(7, 100);
```

На рисунке ниже показан пример ответа на такой запрос.

![](check_sum_for_db_with_normalization.png){:height="80%" width="80%"}
{: .figure-center}
*Запрос CHECK_SUM с коэффициентом нормализации*
{: .figure-caption-center}

## Порядок расчета контрольных сумм {#checksum_algorithms}

### Расчет контрольной суммы по логической таблице или материализованному представлению {#algorithm_for_table}

Контрольная сумма логической таблицы или материализованного представления рассчитывается, 
[как описано в разделе CHECK_DATA](../CHECK_DATA/CHECK_DATA.md#checksum).

### Расчет контрольной суммы по логической базе данных {#algorithm_for_db}

Контрольная сумма логической базы данных рассчитывается так:
1. По каждой логической таблице логической базы данных рассчитывается контрольная сумма, 
   [как описано в разделе CHECK_DATA](../CHECK_DATA/CHECK_DATA.md#checksum).
2. Контрольные суммы всех логических таблиц суммируются — получается 64-битная контрольная сумма 
   логической базы данных.

### Пример расчета контрольной суммы по таблице {#example_for_table}

Рассмотрим пример расчета контрольной суммы по таблице `sales` в дельте, в которой загружено две записи. Для простоты 
возьмем уже рассчитанные контрольные суммы записей: 165074672 
(см. [пример расчета](../CHECK_DATA/CHECK_DATA.md#checksum_example) в разделе [CHECK_DATA](../CHECK_DATA/CHECK_DATA.md)) 
и 87891666.

Контрольная сумма таблицы равна `165074672 + 87891666 = 252966338`.